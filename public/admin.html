<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Kwikset Backend</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .admin-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-card h3 {
            margin: 0 0 10px 0;
            color: #666;
            font-size: 14px;
            text-transform: uppercase;
        }
        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }
        .people-list {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .person-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .person-card.active {
            border-color: #4CAF50;
            background: #f0f9f0;
        }
        .person-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .person-name {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        .status-active {
            background: #4CAF50;
            color: white;
        }
        .status-expired {
            background: #dc3545;
            color: white;
        }
        .status-inactive {
            background: #ff9800;
            color: white;
        }
        .code-info {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
        }
        .code-pin {
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
            letter-spacing: 3px;
        }
        .filter-bar {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }
        .filter-bar input, .filter-bar select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            margin-right: 10px;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 6px;
            transition: background 0.3s;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .access-code-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .access-code-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            border-bottom: 2px solid #e0e0e0;
            font-weight: 600;
            color: #333;
        }
        .access-code-table td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
        }
        .access-code-table tr:hover {
            background: #f8f9fa;
        }
        .access-code-table tr.active-row {
            background: #f0f9f0;
        }
        .code-display {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            letter-spacing: 4px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="admin-header">
            <h1>üîê Admin Dashboard</h1>
            <p>Crappie House Access Code Management</p>
        </div>

        <!-- Statistics -->
        <div class="stats-grid" id="stats-grid">
            <div class="stat-card">
                <h3>Total Purchases</h3>
                <div class="value" id="stat-purchases">0</div>
            </div>
            <div class="stat-card">
                <h3>Active Access Codes</h3>
                <div class="value" id="stat-active">0</div>
            </div>
            <div class="stat-card">
                <h3>People with Access</h3>
                <div class="value" id="stat-people">0</div>
            </div>
            <div class="stat-card">
                <h3>Today's Codes</h3>
                <div class="value" id="stat-today">0</div>
            </div>
            <div class="stat-card">
                <h3>Total Revenue</h3>
                <div class="value" id="stat-revenue">$0.00</div>
            </div>
        </div>

        <!-- Filters and Refresh -->
        <div class="filter-bar">
            <label>
                <input type="checkbox" id="active-only" onchange="loadAll()">
                Show only active codes
            </label>
            <input type="date" id="filter-date" onchange="loadAll()" style="margin-left: 20px;">
            <button class="btn btn-primary" onclick="loadAll()" style="margin-left: 20px; padding: 10px 20px; font-size: 16px;">
                üîÑ Refresh All
            </button>
            <button class="btn btn-danger" onclick="confirmDeleteAll()" style="margin-left: 20px; padding: 10px 20px; font-size: 16px; background: #dc3545; border-color: #dc3545;">
                üóëÔ∏è Delete All Data
            </button>
        </div>

        <!-- Access Codes List -->
        <div class="people-list" style="margin-bottom: 30px;">
            <h2>üîë All Access Codes</h2>
            <div id="access-codes-list" class="loading">Loading...</div>
        </div>

        <!-- People with Access -->
        <div class="people-list">
            <h2>üë• People with Access Codes</h2>
            <div id="people-list" class="loading">Loading...</div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';

        async function loadDashboard() {
            try {
                const response = await fetch(`${API_BASE}/admin/dashboard`);
                const data = await response.json();
                
                if (data.success) {
                    // Update stats
                    document.getElementById('stat-purchases').textContent = data.stats.totalPurchases;
                    document.getElementById('stat-active').textContent = data.stats.activeAccessCodes;
                    document.getElementById('stat-people').textContent = data.stats.peopleWithAccess;
                    document.getElementById('stat-today').textContent = data.stats.todayAccessCodes;
                    document.getElementById('stat-revenue').textContent = `$${data.stats.totalRevenue.toFixed(2)}`;
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        async function loadAccessCodes() {
            const codesList = document.getElementById('access-codes-list');
            codesList.innerHTML = '<div class="loading">Loading...</div>';
            
            try {
                const activeOnly = document.getElementById('active-only').checked;
                const filterDate = document.getElementById('filter-date').value;
                
                let url = `${API_BASE}/admin/access-codes?activeOnly=${activeOnly}`;
                if (filterDate) {
                    url += `&date=${filterDate}`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success && data.accessCodes.length > 0) {
                    codesList.innerHTML = `
                        <table class="access-code-table">
                            <thead>
                                <tr>
                                    <th>Access Code</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Date</th>
                                    <th>Start Time</th>
                                    <th>End Time</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.accessCodes.map(code => {
                                    // Calculate status if not provided (fallback for old data)
                                    let status = code.status;
                                    if (!status) {
                                        const now = new Date();
                                        const start = new Date(code.startsAt);
                                        const end = new Date(code.endsAt);
                                        if (now > end) {
                                            status = 'expired';
                                        } else if (now >= start && now <= end) {
                                            status = 'active';
                                        } else {
                                            status = 'inactive';
                                        }
                                    }
                                    
                                    const statusLabels = {
                                        'active': '‚úì Active',
                                        'expired': '‚úó Expired',
                                        'inactive': '‚óã Inactive'
                                    };
                                    return `
                                        <tr class="${status === 'active' ? 'active-row' : ''}">
                                            <td><span class="code-display">${code.pinCode}</span></td>
                                            <td>${code.customerName}</td>
                                            <td>${code.customerEmail}</td>
                                            <td>${code.customerPhone || 'N/A'}</td>
                                            <td>${formatDate(code.date)}</td>
                                            <td>${new Date(code.startsAt).toLocaleString()}</td>
                                            <td>${new Date(code.endsAt).toLocaleString()}</td>
                                            <td>
                                                <span class="status-badge status-${status}">
                                                    ${statusLabels[status] || status}
                                                </span>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    codesList.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No access codes found with the selected filters.</p>';
                }
            } catch (error) {
                codesList.innerHTML = `<p style="color: red;">Error loading access codes: ${error.message}</p>`;
                console.error('Error loading access codes:', error);
            }
        }

        async function loadPeople() {
            const peopleList = document.getElementById('people-list');
            peopleList.innerHTML = '<div class="loading">Loading...</div>';
            
            try {
                const activeOnly = document.getElementById('active-only').checked;
                const filterDate = document.getElementById('filter-date').value;
                
                let url = `${API_BASE}/admin/people?activeOnly=${activeOnly}`;
                if (filterDate) {
                    url += `&date=${filterDate}`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success && data.people.length > 0) {
                    peopleList.innerHTML = data.people.map(person => {
                        const hasActiveCodes = person.activeCodes > 0;
                        return `
                            <div class="person-card ${hasActiveCodes ? 'active' : ''}">
                                <div class="person-header">
                                    <div>
                                        <div class="person-name">${person.name}</div>
                                        <div style="font-size: 14px; color: #666; margin-top: 5px;">
                                            üìß ${person.email} | üì± ${person.phone || 'N/A'}
                                        </div>
                                    </div>
                                    <span class="status-badge ${hasActiveCodes ? 'status-active' : 'status-expired'}">
                                        ${hasActiveCodes ? 'Active' : 'Expired'}
                                    </span>
                                </div>
                                <div style="margin-top: 15px;">
                                    <strong>Dates:</strong> ${person.dates.map(d => formatDate(d)).join(', ')}
                                </div>
                                <div style="margin-top: 10px;">
                                    <strong>Access Codes (${person.totalCodes} total, ${person.activeCodes} active):</strong>
                                    ${person.accessCodes.map(code => {
                                        // Calculate status if not provided
                                        let codeStatus = code.status;
                                        if (!codeStatus) {
                                            const now = new Date();
                                            const start = new Date(code.startsAt);
                                            const end = new Date(code.endsAt);
                                            if (now > end) {
                                                codeStatus = 'expired';
                                            } else if (now >= start && now <= end) {
                                                codeStatus = 'active';
                                            } else {
                                                codeStatus = 'inactive';
                                            }
                                        }
                                        
                                        const statusLabels = {
                                            'active': '‚úì Active',
                                            'expired': '‚úó Expired',
                                            'inactive': '‚óã Inactive'
                                        };
                                        
                                        return `
                                        <div class="code-info" style="margin-top: 8px;">
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                                <div class="code-pin">${code.pinCode}</div>
                                                <span class="status-badge status-${codeStatus}">
                                                    ${statusLabels[codeStatus] || codeStatus}
                                                </span>
                                            </div>
                                            <div style="font-size: 12px; color: #666;">
                                                Date: ${formatDate(code.date)}<br>
                                                Start: ${new Date(code.startsAt).toLocaleString()}<br>
                                                End: ${new Date(code.endsAt).toLocaleString()}
                                            </div>
                                        </div>
                                    `;
                                    }).join('')}
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    peopleList.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No people found with the selected filters.</p>';
                }
            } catch (error) {
                peopleList.innerHTML = `<p style="color: red;">Error loading people: ${error.message}</p>`;
                console.error('Error loading people:', error);
            }
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const dateParts = dateString.split('-');
            const year = parseInt(dateParts[0]);
            const month = parseInt(dateParts[1]) - 1;
            const day = parseInt(dateParts[2]);
            const date = new Date(year, month, day);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        // Refresh all data
        async function loadAll() {
            await loadDashboard();
            await loadAccessCodes();
            await loadPeople();
        }

        // Delete all data
        async function deleteAllData() {
            try {
                const response = await fetch(`${API_BASE}/admin/clear-all`, {
                    method: 'DELETE',
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ All data has been deleted successfully!');
                    loadAll(); // Refresh the page
                } else {
                    alert('‚ùå Error deleting data: ' + data.error);
                }
            } catch (error) {
                alert('‚ùå Error deleting data: ' + error.message);
                console.error('Error deleting data:', error);
            }
        }

        // Confirm before deleting
        function confirmDeleteAll() {
            const confirmed = confirm(
                '‚ö†Ô∏è WARNING: This will delete ALL purchases and access codes from the database!\n\n' +
                'This action cannot be undone.\n\n' +
                'Are you sure you want to continue?'
            );
            
            if (confirmed) {
                const doubleConfirm = confirm(
                    'üö® FINAL WARNING: This will permanently delete ALL data!\n\n' +
                    'Click OK to confirm deletion.'
                );
                
                if (doubleConfirm) {
                    deleteAllData();
                }
            }
        }

        // Load on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadAll();
        });
    </script>
</body>
</html>

